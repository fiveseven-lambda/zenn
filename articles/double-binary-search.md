---
title: "double ã®äºŒåˆ†æ¢ç´¢ã¯ãƒ«ãƒ¼ãƒ— 64 å›ã§ååˆ†ã™ãã‚‹"
emoji: "ğŸ”ª"
type: "tech"
topics: ['äºŒåˆ†æ¢ç´¢', 'ç«¶ãƒ—ãƒ­']
published: false
---

ã“ã®è¨˜äº‹ã§ã¯ï¼Œã€Œé NaN å€¤ã€ã¨ã„ã†è¨€è‘‰ã‚’ã€Œå®Ÿæ•°ï¼Œæ­£ã®ç„¡é™å¤§ï¼Œè² ã®ç„¡é™å¤§ã®ã†ã¡ï¼Œå€ç²¾åº¦æµ®å‹•å°æ•°ç‚¹æ•°ã§è¡¨ã›ã‚‹æ•°ã€ã¨ã„ã†æ„å‘³ã§ä½¿ã„ã¾ã™ï¼

# åº
å€ç²¾åº¦æµ®å‹•å°æ•°ç‚¹æ•°ï¼ˆC/C++ ã ã¨ `double`ï¼ŒRust ã ã¨ `f64`ï¼‰ã«å¯¾ã™ã‚‹ä»¥ä¸‹ã®ã‚ˆã†ãªäºŒåˆ†æ¢ç´¢ã‚’è€ƒãˆã¾ã™ï¼

- `double` ã‚’å—ã‘å–ã£ã¦ `bool` ã‚’è¿”ã™é–¢æ•° `f` ãŒä¸ãˆã‚‰ã‚Œã‚‹ï¼
- ã‚ã‚‹é NaN å€¤ `x` ãŒå­˜åœ¨ã—ã¦ï¼Œä»»æ„ã®é NaN å€¤ `y` ã«ã¤ã„ã¦
  - `y <= x` ãªã‚‰ `f(y)` ã¯ `true`
  - `y > x` ãªã‚‰ `f(y)` ã¯ `false`

  ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã£ã¦ã„ã‚‹ï¼
- ä¸Šã® `x`ï¼ˆ`f(x)` ãŒ `true` ã¨ãªã‚‹æœ€å¤§ã® `x`ï¼‰ã‚’æ±‚ã‚ãŸã„ï¼

ç«¶ãƒ—ãƒ­ã§ã¯ã“ã‚Œã‚’ã‚ˆãç›¸å¯¾èª¤å·® $10^{-6}$ ä»¥ä¸‹ã¨ã‹ã§æ±‚ã‚ã¾ã™ã­ï¼èª¤å·®ãŒâ—‹â—‹ä»¥ä¸‹ã«ãªã‚‹ã«ã¯ä½•å›ãã‚‰ã„ãƒ«ãƒ¼ãƒ—ã‚’å›ã›ã°ã„ã„ã‚“ã ã‚ã†ï¼Ÿã¿ãŸã„ãªè©±ã«ã‚‚ãªã‚Šã¾ã™ï¼ãŸã¨ãˆã°[ã“ã“ã¨ã‹](https://rsk0315.hatenablog.com/entry/2020/04/29/155009)ï¼

ã§ã‚‚ã‚ˆãè€ƒãˆã‚‹ã¨ï¼Œ`double` ã£ã¦ 64 ãƒ“ãƒƒãƒˆã§ã™ï¼ã¨ã„ã†ã“ã¨ã¯è¡¨ã›ã‚‹æ•°ã¯å¤šãã¦ã‚‚ $2^{64}$ é€šã‚Šï¼ˆå®Ÿéš›ã¯ NaN ã¨ã‹éæ­£è¦åŒ–æ•°ã®ã¶ã‚“ã‚‚ã£ã¨å°‘ãªã„ã§ã™ï¼‰ã§ï¼ŒäºŒåˆ†æ¢ç´¢ã ã¨ã“ã‚ŒãŒæ¯å›ã®ãƒ«ãƒ¼ãƒ—ã§åŠåˆ†ãšã¤æ¸›ã£ã¦ã„ãã®ã§ï¼Œ64 å›ã‚ã‚Œã° `double` ãã®ã‚‚ã®ã®é™ç•Œã¾ã§èª¤å·®ãŒæ¸›ã‚‰ã›ã‚‹ã¯ãšã§ã™ã­ï¼

# ã˜ã‚ƒã‚ãªã‚“ã§æ™®é€šã«ã‚„ã‚‹ã¨ã§ããªã„ã®
æ™®é€šã¯ï¼Œä¸‹é™ $l$ ã¨ä¸Šé™ $r$ ãŒã‚ã£ãŸã‚‰ $m = (l + r) / 2$ ã§åˆ†å‰²ã—ã¾ã™ã­ï¼ã§ã‚‚ï¼ŒãŸã¨ãˆã° $1$ ä»¥ä¸Š $32$ æœªæº€ã®ç¯„å›²ã« `double` å€¤ã¯ $5 \times 2^{52}$ é€šã‚Šã‚ã‚Šã¾ã™ãŒï¼Œãã®ã†ã¡ $80\%$ ã® $4 \times 2^{52}$ å€‹ãŒ $1$ ä»¥ä¸Š $16$ æœªæº€ã®ç¯„å›²ã«ã‚ã‚Šã¾ã™ï¼ã¤ã¾ã‚Šï¼ŒåŠåˆ†ãšã¤ã«åˆ†ã‘ã¦ã„ãã®ãŒäºŒåˆ†æ¢ç´¢ã ã£ãŸã®ã«ï¼Œ$[1, 32)$ ã‚’ $[1, 16)$ ã¨ $[16, 32)$ ã«åˆ†ã‘ã¦ã‚‚ï¼Œãã®ä¸­ã«ã‚ã‚‹ `double` å€¤ã®æ•°ã§è¦‹ã‚‹ã¨åŠåˆ†ã«ãªã£ã¦ã„ãªã‹ã£ãŸã‚ã‘ã§ã™ã­ï¼

# ã©ã†ã—ã‚ˆã†
ç¬¦å·ãªã— 64 ãƒ“ãƒƒãƒˆæ•´æ•°ï¼ˆC/C++ ã ã¨ `std::uint64_t`ï¼ŒRust ã ã¨ `u64`ï¼ç«¶ãƒ—ãƒ­ C/C++ ã§ã¯ `unsigned long long` ã‚‚ï¼‰ã‚’ä½¿ã„ã¾ã™ï¼

`double` ã¨ `std::uint64_t` ã®é–“ã§ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªå¤‰æ›ã‚’è¡Œã„ã¾ã™ï¼
```cpp:C++
std::uint64_t f2u(double x){
    std::uint64_t b;
    std::memcpy(&b, &x, 8);
    return b >> 63 ? ~b : b ^ 1ull << 63;
}

double u2f(std::uint64_t b){
    b = b >> 63 ? b ^ 1ull << 63 : ~b;
    double ret;
    std::memcpy(&ret, &b, 8);
    return ret;
}
```
```rust:Rust
fn f2u(f: f64) -> u64 {
    let b = f.to_bits();
    if b >> 63 == 1 { !b } else { b ^ 1 << 63 }
}
 
fn u2f(b: u64) -> f64 {
    f64::from_bits(if b >> 63 == 1 { b ^ 1 << 63 } else { !b })
}
```
ã“ã®å¤‰æ› `f2u`ï¼Œ`u2f` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ€§è³ªã‚’æº€ãŸã—ã¾ã™ï¼

- é€†å¤‰æ›ã«ãªã£ã¦ã„ã‚‹ï¼šä»»æ„ã®é NaN å€¤ `x` ã«ã¤ã„ã¦ï¼Œ`u2f(f2u(x))` ã¯ `x` ã«ç­‰ã—ã„ï¼
- é †åºã‚’ä¿ã¤ï¼šä»»æ„ã®é NaN å€¤ `x`ï¼Œ`y` ã«ã¤ã„ã¦ï¼Œ`x <= y` ãªã‚‰ã° `f2u(x) <= f2u(y)`ï¼
- é–“ã«é NaN å€¤ä»¥å¤–ã‚’æŒŸã¾ãªã„ï¼š`x`ï¼Œ`y` ãŒé NaN å€¤ã®ã¨ãï¼Œ`f2u(x)` ä»¥ä¸Š `f2u(y)` ä»¥ä¸‹ã®ä»»æ„ã®æ•´æ•° `b` ã«å¯¾ã— `u2f(b)` ã¯é NaN å€¤ï¼

ã“ã®æ€§è³ªã®ãŠã‹ã’ã§ï¼Œ`double` ã®äºŒåˆ†æ¢ç´¢ã¯ 64 ãƒ“ãƒƒãƒˆæ•´æ•°ã®äºŒåˆ†æ¢ç´¢ã¸ã¨æˆã‚Šä¸‹ãŒã‚Šã¾ã™ï¼ã‚ã¨ã¯æ™®é€šã®äºŒåˆ†æ¢ç´¢ã«çªã£è¾¼ã‚ã°ï¼Œå¤šãã¦ã‚‚ 64 å›ã§ `double` ã®é™ç•Œã¾ã§ã„ã‘ã‚‹äºŒåˆ†æ¢ç´¢ã®å®Œæˆã§ã™ï¼
```cpp
// æ™®é€šã®ï¼ˆæ•´æ•°ã«å¯¾ã™ã‚‹ï¼‰äºŒåˆ†æ¢ç´¢
template <class F>
std::uint64_t binary_search(F f, std::uint64_t l, std::uint64_t r){
    while(l + 1 < r){
        std::uint64_t mid = l + (r - l) / 2;
        (f(mid) ? l : r) = mid;
    }
    return l;
}

// double äºŒåˆ†æ¢ç´¢
template <class F>
double binary_search_double(F f, double l = -INFINITY, double r = INFINITY){
    return i2f(
        binary_search(
            [&](std::uint64_t b){ return f(i2f(b)); },
            f2i(l), f2i(r)
        )
    );
}
```